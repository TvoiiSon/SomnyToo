# SomnyToo — Техническая документация

## 1. Назначение системы

**SomnyToo** — это высокопроизводительная серверная система, реализующая защищённый бинарный протокол поверх TCP с акцентом на криптографическую устойчивость к атакам на память и побочные каналы.

Ключевая особенность системы заключается в реализации архитектуры *эфемерной криптографии*, при которой криптографические ключи не существуют в памяти как целостные объекты, за исключением строго ограниченных по времени вычислительных операций.

Система предназначена для эксплуатации в средах, где предполагается возможность частичной компрометации памяти, анализа временных характеристик выполнения и атак через общие аппаратные ресурсы.

---

## 2. Фундаментальные принципы безопасности

Криптографическая модель SomnyToo основана на архитектуре **Phantom Security**, опирающейся на два взаимосвязанных принципа.

### 2.1 Пространственное рассеивание ключевого материала

Криптографические ключи подвергаются детерминированному разделению на компоненты, которые распределяются по различным уровням иерархии памяти процессора. Каждый компонент по отдельности не содержит информации, достаточной для восстановления исходного ключа.

### 2.2 Временная эфемерность

Все ключевые материалы имеют строго ограниченное время жизни. После завершения криптографической операции соответствующие данные подлежат немедленному уничтожению.

---

## 3. Модель доверия памяти и угроз

### 3.1 Иерархия доверия памяти

Используемая модель учитывает архитектурные особенности современных процессоров.

| Уровень памяти | Характеристика | Уровень доверия |
|---------------|---------------|-----------------|
| Регистры CPU  | Минимальное время доступа, недоступны прямому адресованию | Высокий |
| Кэш L1        | Высокая скорость, потенциальные side-channel атаки | Средний |
| Кэш L2        | Более высокая латентность, устойчивость к вытеснению | Средний |
| RAM           | Подвержена дампам, DMA и cold-boot атакам | Низкий |

### 3.2 Предполагаемая модель атак

Система проектируется с учётом следующих допущений:

- атакующий может получить доступ к одному или нескольким уровням памяти;
- возможен анализ времени выполнения операций;
- возможен анализ паттернов доступа к кэш-памяти;
- одновременный доступ ко всем уровням памяти в момент сборки ключа считается маловероятным.

---

## 4. Механизм рассеивания ключей

### 4.1 Общая характеристика

Процесс рассеивания преобразует мастер-ключ сессии в набор компонентов, распределённых по уровням памяти с различными характеристиками безопасности.

Компоненты, размещаемые в оперативной памяти, хранятся исключительно в зашифрованном и аутентифицированном виде. Исходный ключ и все промежуточные значения подлежат немедленному занулению.

### 4.2 Криптографические свойства

Механизм рассеивания обеспечивает:

- невозможность восстановления ключа при компрометации одного компонента;
- устойчивость к дампам оперативной памяти;
- защиту от частичного анализа кэша;
- отсутствие статического ключевого материала в памяти.

---

## 5. Сборка ключей

### 5.1 Общий алгоритм

Сборка ключа выполняется исключительно в момент криптографической операции и обладает следующими свойствами:

- детерминированность результата;
- фиксированное количество итераций;
- отсутствие ветвлений, зависящих от секретных данных;
- линейный и предсказуемый доступ к памяти.

### 5.2 Защита от побочных каналов

Алгоритм сборки спроектирован как *constant-time* и устойчив к:

- timing-атакам;
- анализу кэш-доступа;
- частичной компрометации памяти.

После завершения операции все временные буферы очищаются.

---

## 6. Сессионная архитектура

### 6.1 Сессия безопасности

Сессия представляет собой контекст защищённого взаимодействия между двумя сторонами и включает:

- идентификатор сессии;
- рассеянный мастер-ключ;
- счётчики операций;
- параметры жизненного цикла.

### 6.2 Типы ключей

| Тип ключа | Назначение | Время жизни |
|----------|-----------|-------------|
| Мастер-ключ сессии | Деривация операционных ключей | Десятки секунд |
| Операционный ключ | Шифрование одного пакета или операции | Миллисекунды |

Операционные ключи являются уникальными и не переиспользуются.

---

## 7. Протокол установления соединения

### 7.1 Назначение handshake-протокола

Handshake-протокол обеспечивает:

- взаимную аутентификацию сторон;
- установление общего секрета;
- защиту от атак типа Man-in-the-Middle;
- инициализацию криптографической сессии.

### 7.2 Криптографические свойства

Протокол исключает использование статических долгоживущих ключей и реализуется с учётом защиты от атак отказа в обслуживании и анализа временных характеристик.

---

## 8. Формат и обработка сетевых пакетов

### 8.1 Общие принципы

Каждый сетевой пакет является самодостаточной криптографической единицей и обрабатывается независимо от других пакетов.

### 8.2 Свойства обработки

- уникальный ключ для каждого пакета;
- аутентификация и проверка целостности;
- проверка последовательности и временной корректности;
- обработка без динамического выделения памяти.

---

## 9. Используемые криптографические примитивы

Выбор алгоритмов обусловлен требованиями устойчивости к побочным каналам и высокой производительности.

| Примитив | Назначение |
|--------|------------|
| X25519 | Обмен ключами и совершенная прямая секретность |
| ChaCha20-Poly1305 | Симметричное шифрование с аутентификацией |
| BLAKE3 | Хэширование, KDF и подпись контекста |

---

## 10. Область применения и покрываемые задачи

Разработка SomnyToo позволяет реализовать:

- защищённые TCP-соединения с эфемерной криптографией;
- серверы реального времени с предсказуемой латентностью;
- системы, устойчивые к дампам памяти и side-channel атакам;
- криптографически изолированные сессии и пакеты;
- высоконагруженные распределённые сетевые сервисы;
- протоколы передачи данных с жёсткими требованиями к безопасности и контролю жизненного цикла ключей.

SomnyToo ориентирован на использование в системах, где безопасность ключевого материала в памяти рассматривается как вероятностная, а не абсолютная величина, и компенсируется архитектурными и криптографическими методами.