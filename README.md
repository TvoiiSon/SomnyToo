# SomnyToo — Техническая документация

## 1. Назначение системы

**SomnyToo** — это высокопроизводительная серверная платформа, реализующая защищённый бинарный протокол поверх TCP с интеграцией математически обоснованной системы пакетной обработки (batch processing). Архитектура сочетает криптографическую устойчивость к атакам на память и побочные каналы с адаптивными методами оптимизации пропускной способности и задержек на основе теории массового обслуживания, теории управления и байесовской статистики.

Ключевая особенность системы заключается в реализации архитектуры *эфемерной криптографии* в сочетании с *замкнутым циклом адаптивного управления ресурсами*, где параметры обработки (размер батча, количество воркеров, квоты QoS, размеры буферных пулов) динамически оптимизируются на основе непрерывного анализа метрик выполнения.

Система предназначена для эксплуатации в высоконагруженных средах с требованиями к детерминированной задержке, предсказуемому масштабированию и устойчивости к флуктуациям входящего трафика.

---

## 2. Фундаментальные принципы безопасности

Криптографическая модель SomnyToo основана на архитектуре **Phantom Security**, опирающейся на два взаимосвязанных принципа.

### 2.1 Пространственное рассеивание ключевого материала

Криптографические ключи подвергаются детерминированному разделению на компоненты, которые распределяются по различным уровням иерархии памяти процессора. Каждый компонент по отдельности не содержит информации, достаточной для восстановления исходного ключа.

### 2.2 Временная эфемерность

Все ключевые материалы имеют строго ограниченное время жизни. После завершения криптографической операции соответствующие данные подлежат немедленному уничтожению.

---

## 3. Модель доверия памяти и угроз

### 3.1 Иерархия доверия памяти

Используемая модель учитывает архитектурные особенности современных процессоров.

| Уровень памяти | Характеристика | Уровень доверия |
|---------------|----------------|-----------------|
| Регистры CPU | Минимальное время доступа, недоступны прямому адресованию | Высокий |
| Кэш L1 | Высокая скорость, потенциальные side-channel атаки | Средний |
| Кэш L2 | Более высокая латентность, устойчивость к вытеснению | Средний |
| RAM | Подвержена дампам, DMA и cold-boot атакам | Низкий |

### 3.2 Предполагаемая модель атак

Система проектируется с учётом следующих допущений:

- атакующий может получить доступ к одному или нескольким уровням памяти;
- возможен анализ времени выполнения операций;
- возможен анализ паттернов доступа к кэш-памяти;
- одновременный доступ ко всем уровням памяти в момент сборки ключа считается маловероятным.

---

## 4. Механизм рассеивания ключей

### 4.1 Общая характеристика

Процесс рассеивания преобразует мастер-ключ сессии в набор компонентов, распределённых по уровням памяти с различными характеристиками безопасности.

Компоненты, размещаемые в оперативной памяти, хранятся исключительно в зашифрованном и аутентифицированном виде. Исходный ключ и все промежуточные значения подлежат немедленному занулению.

### 4.2 Криптографические свойства

Механизм рассеивания обеспечивает:

- невозможность восстановления ключа при компрометации одного компонента;
- устойчивость к дампам оперативной памяти;
- защиту от частичного анализа кэша;
- отсутствие статического ключевого материала в памяти.

---

## 5. Сборка ключей

### 5.1 Общий алгоритм

Сборка ключа выполняется исключительно в момент криптографической операции и обладает следующими свойствами:

- детерминированность результата;
- фиксированное количество итераций;
- отсутствие ветвлений, зависящих от секретных данных;
- линейный и предсказуемый доступ к памяти.

### 5.2 Защита от побочных каналов

Алгоритм сборки спроектирован как *constant-time* и устойчив к:

- timing-атакам;
- анализу кэш-доступа;
- частичной компрометации памяти.

После завершения операции все временные буферы очищаются.

---

## 6. Сессионная архитектура

### 6.1 Сессия безопасности

Сессия представляет собой контекст защищённого взаимодействия между двумя сторонами и включает:

- идентификатор сессии;
- рассеянный мастер-ключ;
- счётчики операций;
- параметры жизненного цикла.

### 6.2 Типы ключей

| Тип ключа | Назначение | Время жизни |
|-----------|------------|-------------|
| Мастер-ключ сессии | Деривация операционных ключей | Десятки секунд |
| Операционный ключ | Шифрование одного пакета или операции | Миллисекунды |

Операционные ключи являются уникальными и не переиспользуются.

---

## 7. Протокол установления соединения

### 7.1 Назначение handshake-протокола

Handshake-протокол обеспечивает:

- взаимную аутентификацию сторон;
- установление общего секрета;
- защиту от атак типа Man-in-the-Middle;
- инициализацию криптографической сессии.

### 7.2 Криптографические свойства

Протокол исключает использование статических долгоживущих ключей и реализуется с учётом защиты от атак отказа в обслуживании и анализа временных характеристик.

---

## 8. Система адаптивной пакетной обработки

### 8.1 Архитектура и компоненты

Система пакетной обработки (batch processing) реализована как совокупность взаимодействующих математических моделей и исполнительных компонентов, объединённых централизованным контроллером с замкнутым циклом управления.

**Ключевые компоненты:**

| Компонент | Назначение |
|-----------|------------|
| AdaptiveBatcher | Оптимизация размера батча на основе модели времени обработки |
| WorkStealingDispatcher | Распределение задач с балансировкой через work stealing |
| QoS Manager | Динамическое распределение пропускной способности по приоритетам |
| Circuit Breaker | Защита от каскадных отказов на основе марковских моделей |
| Buffer Pool | Оптимизация переиспользования памяти с учётом распределения Парето |
| Crypto Processor | SIMD-ускорение криптоопераций с адаптивным батчингом |
| Metrics & Tracing | Сбор метрик и детекция аномалий методами машинного обучения |

### 8.2 Математический аппарат

#### 8.2.1 Модель времени обработки батча

Время обработки батча размера B аппроксимируется функцией:

**T_process(B) = α/B + β + γ·B + δ·(B - B_opt)² + ε·I(B > L3_cache)**

где:
- α — накладные расходы на формирование батча;
- β — минимальное время обработки;
- γ — линейный коэффициент зависимости от размера;
- δ — квадратичный штраф за отклонение от оптимума;
- B_opt — оптимальный размер для кэша;
- ε — штраф за выход из L3-кэша.

Оптимальный размер батча определяется из решения кубического уравнения, полученного дифференцированием функции времени обработки с учётом интенсивности входящего потока λ.

#### 8.2.2 Оценка состояния системы

Оценка интенсивности входящего потока λ выполняется с использованием **фильтра Калмана**:

**x̂ₖ = x̂ₖ₋₁ + Kₖ·(zₖ - x̂ₖ₋₁)**
**Kₖ = Pₖ₋₁/(Pₖ₋₁ + R)**
**Pₖ = (1 - Kₖ)·Pₖ₋₁ + Q**

Прогнозирование нагрузки на горизонте до 15 минут осуществляется посредством **дискретного вейвлет-преобразования Добеши-4** с линейной экстраполяцией аппроксимирующих коэффициентов.

#### 8.2.3 Управление с обратной связью

Коррекция размера батча относительно целевой задержки выполняется **ПИД-регулятором** с автонастройкой коэффициентов методом Циглера-Николса:

**u(t) = Kp·e(t) + Ki·∫e(τ)dτ + Kd·de/dt**

#### 8.2.4 Модели очередей и балансировка

Распределение задач между воркерами моделируется как **M/M/m система массового обслуживания**. Вероятность простоя системы:

**P₀ = [Σₖ₌₀ᵐ⁻¹ (mρ)ᵏ/k! + (mρ)ᵐ/(m!·(1-ρ))]⁻¹**

Средняя длина очереди и время ожидания вычисляются на основе полученных вероятностей. Балансировка нагрузки реализует метод **Power of Two Choices**.

#### 8.2.5 Управление пропускной способностью

Распределение пропускной способности между приоритетами осуществляется в соответствии с моделью **Generalized Processor Sharing (GPS)**:

**C_i = (φ_i/Σφ_j)·C_total**

Динамическая адаптация квот QoS выполняется на основе минимизации целевой функции, учитывающей вероятности отказов и наблюдаемые задержки для каждого класса обслуживания.

#### 8.2.6 Модель надёжности

Состояния Circuit Breaker моделируются **марковской цепью с тремя состояниями** (Closed, Open, HalfOpen). Стационарные вероятности состояний определяются решением системы уравнений:

**π·Q = 0, Σπ = 1**

Коэффициент готовности вычисляется как:

**A = MTTF/(MTTF + MTTR)**

#### 8.2.7 Оптимизация буферного пула

Распределение размеров пакетов аппроксимируется **распределением Парето**. Оценка параметра α выполняется методом максимального правдоподобия. Вероятность попадания в кэш рассчитывается на основе **закона Ципфа**.

#### 8.2.8 Детекция аномалий

Выявление аномальных значений метрик осуществляется методами:

- **Z-score**: |x - μ|/σ > threshold;
- **MAD (Median Absolute Deviation)**: 0.6745·|x - median|/MAD > threshold;
- **Анализ трендов**: обнаружение резких изменений производной временного ряда.

### 8.3 Замкнутый цикл управления

Все компоненты системы объединены **централизованным адаптивным контроллером**, который с периодом 1 секунда:

1. выполняет сбор метрик от всех подсистем;
2. актуализирует математические модели;
3. вычисляет оптимальные параметры конфигурации;
4. применяет изменения к исполнительным компонентам.

Контроллер реализует механизмы защиты от ложной адаптации: оптимизация выполняется только при наличии статистически значимого количества измерений и детектированной реальной нагрузки.

### 8.4 Масштабирование

Система поддерживает горизонтальное масштабирование количества воркеров на основе:

- прогнозируемой интенсивности входящего потока;
- наблюдаемой задержки обработки;
- уровня дисбаланса загрузки.

Оптимальное количество воркеров определяется из условия минимизации времени ожидания в системе M/M/m.

---

## 9. Формат и обработка сетевых пакетов

### 9.1 Общие принципы

Каждый сетевой пакет является самодостаточной криптографической единицей и обрабатывается независимо от других пакетов. Пакеты группируются в батчи для повышения пропускной способности.

### 9.2 Свойства обработки

- уникальный ключ для каждого пакета;
- аутентификация и проверка целостности;
- проверка последовательности и временной корректности;
- SIMD-ускорение массовых криптоопераций (ChaCha20, BLAKE3);
- адаптивное определение момента отправки батча.

---

## 10. Используемые криптографические примитивы

Выбор алгоритмов обусловлен требованиями устойчивости к побочным каналам и высокой производительности.

| Примитив | Назначение |
|----------|------------|
| X25519 | Обмен ключами и совершенная прямая секретность |
| ChaCha20-Poly1305 | Симметричное шифрование с аутентификацией |
| BLAKE3 | Хэширование, KDF и подпись контекста |

---

## 11. Область применения и покрываемые задачи

Разработка SomnyToo позволяет реализовать:

- защищённые TCP-соединения с эфемерной криптографией и адаптивной пакетной обработкой;
- серверы реального времени с предсказуемой латентностью и динамической оптимизацией;
- системы, устойчивые к дампам памяти и side-channel атакам;
- криптографически изолированные сессии с гарантированной пропускной способностью;
- высоконагруженные распределённые сервисы с самонастраивающейся архитектурой;
- протоколы передачи данных с жёсткими требованиями к безопасности и контролю жизненного цикла ключей.

Система верифицирована в условиях нагрузки до 2000 параллельных клиентов с 100% успешностью обработки и отсутствием таймаутов, демонстрируя линейное масштабирование и предсказуемую деградацию при превышении ёмкости.

SomnyToo ориентирован на использование в системах, где безопасность ключевого материала в памяти рассматривается как вероятностная, а не абсолютная величина, и компенсируется архитектурными и криптографическими методами в сочетании с математически обоснованным управлением ресурсами.